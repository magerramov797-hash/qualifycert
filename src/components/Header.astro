---
import LanguageSwitcher from "./LanguageSwitcher.astro";
import { translations } from "../i18n/translations";

const brand = "QualifyCert";
const { lang = "az", currentPath = "/" } = Astro.props;

const t = translations[lang];
const prefix = lang === "az" ? "" : `/${lang}`;
const link = (path) => `${prefix}${path === "/" ? "/" : path}`;

// dropdown items
const servicesItems = [
  {
    href: "/services/certification/",
    label:
      t.nav.servicesSub?.certification ??
      (lang === "ru" ? "ISO-сертификация" : lang === "en" ? "ISO certification" : "ISO sertifikatlaşdırma"),
  },
  {
    href: "/services/audit/",
    label: t.nav.servicesSub?.audit ?? (lang === "ru" ? "Аудит" : lang === "en" ? "Audit" : "Audit"),
  },
  {
    href: "/services/training/",
    label: t.nav.servicesSub?.training ?? (lang === "ru" ? "Обучение" : lang === "en" ? "Training" : "Təlim"),
  },
];

const standardsItems = [
  { href: "/standards/iso-9001/", label: "ISO 9001" },
  { href: "/standards/iso-14001/", label: "ISO 14001" },
  { href: "/standards/iso-45001/", label: "ISO 45001" },
  { href: "/standards/iso-22000/", label: "ISO 22000" },
  { href: "/standards/haccp/", label: "HACCP" },
];

const industriesItems = [
  { href: "/industries/", label: lang === "ru" ? "Все отрасли" : lang === "en" ? "All industries" : "Bütün sahələr" },
];
---

<header class="site-header">
  <div class="container header-row">
    <!-- Brand -->
    <a href={link("/")} class="brand" aria-label={brand}>
      <img src="/images/logo.png?v=1" alt={brand} width="34" height="34" loading="eager" />
      <strong class="brand-text">{brand}</strong>
    </a>

    <!-- Desktop nav -->
    <nav class="nav-desktop" aria-label="Primary navigation">
      <!-- Services -->
      <div class="nav-dd">
        <a class="nav-link nav-dd-trigger" href={link("/services/")}>
          {t.nav.services} <span class="nav-caret" aria-hidden="true">▾</span>
        </a>
        <div class="nav-dd-menu" role="menu">
          {servicesItems.map((it) => (
            <a role="menuitem" class="nav-dd-item" href={link(it.href)}>{it.label}</a>
          ))}
        </div>
      </div>

      <!-- Standards -->
      <div class="nav-dd">
        <a class="nav-link nav-dd-trigger" href={link("/standards/")}>
          {t.nav.standards} <span class="nav-caret" aria-hidden="true">▾</span>
        </a>
        <div class="nav-dd-menu" role="menu">
          {standardsItems.map((it) => (
            <a role="menuitem" class="nav-dd-item" href={link(it.href)}>{it.label}</a>
          ))}
        </div>
      </div>

      <!-- Industries -->
      <div class="nav-dd">
        <a class="nav-link nav-dd-trigger" href={link("/industries/")}>
          {t.nav.industries} <span class="nav-caret" aria-hidden="true">▾</span>
        </a>
        <div class="nav-dd-menu" role="menu">
          {industriesItems.map((it) => (
            <a role="menuitem" class="nav-dd-item" href={link(it.href)}>{it.label}</a>
          ))}
        </div>
      </div>

      <a class="nav-link" href={link("/blog/")}>{t.nav.blog}</a>
      <a class="nav-link" href={link("/faq/")}>{t.nav.faq}</a>
      <a class="nav-link" href={link("/about/")}>{t.nav.about}</a>
      <a class="nav-link" href={link("/contact/")}>{t.nav.contact}</a>

      <LanguageSwitcher currentLang={lang} currentPath={currentPath} />

      <a href={link("/contact/")} class="btn primary nav-cta">{t.nav.cta}</a>
    </nav>

    <!-- Mobile -->
    <details class="nav-mobile">
      <summary class="btn btn-sm">Menu</summary>
      <div class="mobile-panel">
        <details class="mob-dd">
          <summary class="mob-dd-summary">{t.nav.services}</summary>
          <div class="mob-dd-list">
            <a href={link("/services/")}>{t.nav.services}</a>
            {servicesItems.map((it) => <a href={link(it.href)}>{it.label}</a>)}
          </div>
        </details>

        <details class="mob-dd">
          <summary class="mob-dd-summary">{t.nav.standards}</summary>
          <div class="mob-dd-list">
            <a href={link("/standards/")}>{t.nav.standards}</a>
            {standardsItems.map((it) => <a href={link(it.href)}>{it.label}</a>)}
          </div>
        </details>

        <details class="mob-dd">
          <summary class="mob-dd-summary">{t.nav.industries}</summary>
          <div class="mob-dd-list">
            {industriesItems.map((it) => <a href={link(it.href)}>{it.label}</a>)}
          </div>
        </details>

        <a href={link("/blog/")}>{t.nav.blog}</a>
        <a href={link("/faq/")}>{t.nav.faq}</a>
        <a href={link("/about/")}>{t.nav.about}</a>
        <a href={link("/contact/")}>{t.nav.contact}</a>

        <LanguageSwitcher currentLang={lang} currentPath={currentPath} />
        <a href={link("/contact/")} class="btn primary">{t.nav.cta}</a>
      </div>
    </details>
  </div>
</header>

<style is:global>
  .site-header{
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgba(255,255,255,.86);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--line);
  }

  .header-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 10px 0;
    gap: 12px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap: 10px;
    min-width: 0;
  }
  .brand img{
    width: 34px;
    height: 34px;
    max-width: none !important;
    flex: 0 0 auto;
  }
  .brand-text{
    font-size: 14px;
    letter-spacing: -0.01em;
    white-space: nowrap;
  }

  .nav-desktop{
    display:flex;
    align-items:center;
    gap: 14px;
    font-size: 14px;
  }
  .nav-link{
    white-space: nowrap;
    padding: 8px 8px;
    border-radius: 10px;
  }
  .nav-link:hover{
    background: rgba(37,99,235,.06);
    color: inherit;
  }

  .btn-sm{ padding: 10px 14px; }

  .nav-cta{
    min-width: 172px;
    padding: 10px 16px;
    font-size: 14px;
    white-space: nowrap;
    justify-content: center;
  }

  /* ===== Desktop dropdown (NO hover исчезновения) ===== */
  .nav-dd{
    position: relative;
    display:inline-flex;
    align-items:center;
  }
  .nav-dd-trigger{
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .nav-caret{
    font-size: 11px;
    opacity:.6;
    transform: translateY(-1px);
  }

  .nav-dd-menu{
    position:absolute;
    left: 0;
    top: 100%;                 /* без разрыва */
    transform: translateY(8px); /* визуальный отступ вниз */
    min-width: 240px;
    padding: 8px;
    border-radius: var(--radius);
    background: var(--card);
    border: 1px solid var(--line);
    box-shadow: var(--shadow-md);
    display:none;
    z-index: 60;
  }

  /* “мостик” чтобы курсор не терял hover между ссылкой и меню */
  .nav-dd-menu::before{
    content:"";
    position:absolute;
    left: 0;
    right: 0;
    top: -12px;
    height: 12px;
  }

  .nav-dd-item{
    display:block;
    padding: 9px 10px;
    border-radius: 12px;
    border: 1px solid transparent;
    white-space: nowrap;
    font-size: 14px;
  }
  .nav-dd-item:hover{
    border-color: rgba(37,99,235,.18);
    background: rgba(37,99,235,.04);
    color: inherit;
  }

  .nav-dd:hover .nav-dd-menu,
  .nav-dd:focus-within .nav-dd-menu{
    display:block;
  }

  /* ===== Mobile ===== */
  .nav-mobile{ display:none; position: relative; }

  .mobile-panel{
    position: absolute;
    right: 0;
    top: calc(100% + 10px);
    width: min(360px, calc(100vw - 24px));
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    padding: 12px;
    display: grid;
    gap: 10px;
  }

  .mobile-panel a{
    display:block;
    width:100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid transparent;
    background:#fff;
    line-height: 1.35;
    white-space: normal;
  }

  .mobile-panel a:hover{
    border-color: rgba(37,99,235,.18);
    background: rgba(37,99,235,.04);
    color: inherit;
  }

  .mob-dd{
    border: 1px solid var(--line);
    border-radius: 14px;
    background: rgba(37,99,235,.03);
    padding: 6px 8px;
  }

  .mob-dd-summary{
    list-style:none;
    cursor:pointer;
    user-select:none;
    font-weight:800;
    padding: 10px 8px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .mob-dd-summary::-webkit-details-marker{ display:none; }

  .mob-dd-list{
    display:grid;
    grid-template-columns: 1fr;
    gap: 8px;
    padding: 6px 4px 10px;
  }
  .mob-dd-list a{ background:#fff; }
  .mob-dd-list a:first-child{ font-weight: 700; }

  @media (max-width: 900px){
    .nav-desktop{ display:none !important; }
    .nav-mobile{ display:block !important; }
    .mobile-panel .btn{ width: 100%; }
  }
</style>

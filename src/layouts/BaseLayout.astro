---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import type { Lang } from "../i18n/translations";

const MAINTENANCE = false; // true = скрыть Header/Footer (только контент страницы)
const { title = "ISO Certification & Training", description = "ISO sertifikatlaşdırma, audit və təlim." } = Astro.props;

const pathname = Astro.url.pathname;
let lang: Lang = "az";
if (pathname === "/ru" || pathname.startsWith("/ru/")) lang = "ru";
if (pathname === "/en" || pathname.startsWith("/en/")) lang = "en";

const basePath = lang === "az" ? pathname : pathname.replace(/^\/(ru|en)/, "") || "/";

const canonicalPath = lang === "az" ? basePath : `/${lang}${basePath === "/" ? "/" : basePath}`;
const canonicalUrl = Astro.site ? new URL(canonicalPath, Astro.site) : new URL(canonicalPath, Astro.url);

const hreflangUrl = (targetLang: Lang) => {
  const path = targetLang === "az" ? basePath : `/${targetLang}${basePath === "/" ? "/" : basePath}`;
  return Astro.site ? new URL(path, Astro.site) : new URL(path, Astro.url);
};
---

<!doctype html>
<html lang={lang}>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{title}</title>
  <meta name="description" content={description} />

  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="/favicon.png?v=5" />
  <link rel="canonical" href={canonicalUrl} />

  <link rel="alternate" hreflang="az" href={hreflangUrl("az")} />
  <link rel="alternate" hreflang="ru" href={hreflangUrl("ru")} />
  <link rel="alternate" hreflang="en" href={hreflangUrl("en")} />
  <link rel="alternate" hreflang="x-default" href={hreflangUrl("az")} />
</head>

<body style="min-height:100vh; display:flex; flex-direction:column;">
  {MAINTENANCE ? (
    <main style="flex:1;">
      <slot />
    </main>
  ) : (
    <>
      <Header lang={lang} currentPath={basePath} />
      <main style="flex:1;">
        <slot />
      </main>
      <Footer lang={lang} currentPath={basePath} />
    </>
  )}

  <script>
    const items = document.querySelectorAll(".reveal");
    if ("IntersectionObserver" in window) {
      const io = new IntersectionObserver(
        (entries) => {
          for (const e of entries) {
            if (e.isIntersecting) {
              e.target.classList.add("is-visible");
              io.unobserve(e.target);
            }
          }
        },
        { threshold: 0.12 }
      );
      items.forEach((el) => io.observe(el));
    } else {
      items.forEach((el) => el.classList.add("is-visible"));
    }
  </script>
</body>
</html>
